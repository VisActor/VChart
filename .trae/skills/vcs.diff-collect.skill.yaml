id: vcs.diff-collect
version: v1
description: 采集分支差异与工作树变更并生成结构化 JSON
domain: vcs
runner: orchestrator
dependencies:
  - git-cli
env: {}
parameters:
  - name: sinceBranch
    type: string
    default: develop
    required: false
  - name: includeWorkingTree
    type: boolean
    default: true
    required: false
inputs: {}
outputs:
  - name: diff_json
    path: ./.trae/output/diff.json
success_criteria:
  - diff_collected
steps:
  - name: fetch
    type: command
    uses: git-cli
    with:
      command: git fetch --all --prune
  - name: diff-files
    type: command
    uses: git-cli
    with:
      command: "git diff --name-status --diff-filter=AMR ${parameters.sinceBranch}...HEAD"
    save_as: changedFiles
  - name: working-tree
    type: command
    uses: git-cli
    with:
      command: git status --porcelain
    when: "parameters.includeWorkingTree == true"
    save_as: workingTree
  - name: line-diff
    type: composite
    with:
      for_each: changedFiles
      do:
        - type: command
          uses: git-cli
          with:
            command: "git diff --unified=0 ${parameters.sinceBranch}...HEAD ${item}"
          save_as: lineDiffCommitted
        - type: command
          uses: git-cli
          with:
            command: "git diff --cached --unified=0 -- ${item}"
          save_as: lineDiffStaged
        - type: command
          uses: git-cli
          with:
            command: "git diff --unified=0 -- ${item}"
          save_as: lineDiffUnstaged
  - name: write-json
    type: command
    uses: shell
    with:
      command: "echo '{}' > ./.trae/output/diff.json"
    save_as: diff_json

