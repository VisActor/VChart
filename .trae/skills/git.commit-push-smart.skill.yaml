id: git.commit-push-smart
version: v1
description: 智能生成提交信息并推送当前分支
domain: git
runner: orchestrator
dependencies:
  - git-cli
env: {}
parameters:
  - name: head
    type: string
    default: ''
    required: false
  - name: commitAllowEmpty
    type: boolean
    default: false
    required: false
  - name: pushAfterCommit
    type: boolean
    default: true
    required: false
  - name: commitMessageStrategy
    type: enum
    values: [auto, manual]
    default: auto
    required: false
  - name: message
    type: string
    default: ''
    required: false
inputs: {}
outputs:
  - name: commit_message
  - name: pushed_branch
success_criteria:
  - commit_created_or_skipped
steps:
  - name: resolve-head
    type: command
    uses: git-cli
    with:
      command: git rev-parse --abbrev-ref HEAD
    when: "parameters.head == ''"
    save_as: head
  - name: check-working-tree
    type: command
    uses: git-cli
    with:
      command: git status --porcelain
    save_as: workingTree
  - name: skip-if-empty
    type: composite
    with:
      condition: "workingTree == '' && parameters.commitAllowEmpty == false"
      set_outputs:
        commit_message: ''
        pushed_branch: "${head}"
      mark_success: commit_created_or_skipped
  - name: derive-message
    type: composite
    with:
      strategy: "parameters.commitMessageStrategy"
      manual_message: "parameters.message"
    save_as: commitMessage
  - name: commit
    type: command
    uses: git-cli
    with:
      command: "git add --all && git commit ${parameters.commitAllowEmpty ? '--allow-empty ' : ''}-m \"${commitMessage}\""
    save_as: commit_message
  - name: push
    type: command
    uses: git-cli
    with:
      command: "git push -u origin ${head}"
    when: "parameters.pushAfterCommit == true"
    save_as: pushed_branch

