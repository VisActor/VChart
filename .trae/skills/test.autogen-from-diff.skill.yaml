id: test.autogen-from-diff
version: v1
description: 根据分支差异与导出符号，自动生成或增量更新单测并输出报告
domain: testing
runner: orchestrator
dependencies:
  - rush-cli
  - jest-cli
env: {}
parameters:
  - name: project
    type: string
    default: auto
    required: false
  - name: mode
    type: enum
    values: [full]
    default: full
    required: false
  - name: noSnapshot
    type: boolean
    default: false
    required: false
  - name: onlyNew
    type: boolean
    default: false
    required: false
  - name: applyManualOverrides
    type: boolean
    default: true
    required: false
  - name: replaceAutogen
    type: boolean
    default: false
    required: false
  - name: dryRun
    type: boolean
    default: false
    required: false
  - name: preview
    type: boolean
    default: false
    required: false
  - name: stopOnError
    type: boolean
    default: true
    required: false
  - name: focusChangedOnly
    type: boolean
    default: false
    required: false
  - name: snapshotStrategy
    type: enum
    values: [combined]
    default: combined
    required: false
  - name: tempReportPath
    type: string
    default: ./.trae/output/autotest.report.local.md
    required: false
inputs:
  - name: diff_json
    type: file
    default: ./.trae/output/diff.json
outputs:
  - name: test_files
  - name: snapshots
  - name: coverage_report
  - name: manual_nodes
  - name: temp_markdown_report
success_criteria:
  - tests_generated_for_changed_exports
  - compile_without_errors
  - coverage_increase_or_maintained
steps:
  - name: analyze
    type: composite
    with:
      source: diff_json
      strategy: exports-and-branches
  - name: generate-tests
    type: composite
    with:
      layout: __tests__/*.test.ts
      comments: function-level-jsdoc
      autogen_block: true
      only_new: "${parameters.onlyNew}"
      replace_autogen: "${parameters.replaceAutogen}"
  - name: run-tests
    type: command
    uses: rush-cli
    with:
      command: "rush run ${parameters.project != 'auto' ? '-p ' + parameters.project : ''} -s test"
  - name: run-coverage
    type: command
    uses: rush-cli
    with:
      command: "rush run ${parameters.project != 'auto' ? '-p ' + parameters.project : ''} -s test-cov"
  - name: write-report
    type: command
    uses: shell
    with:
      command: "echo '# Autotest 报告' > ${parameters.tempReportPath}"
    save_as: temp_markdown_report

